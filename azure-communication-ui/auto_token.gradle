import groovy.json.JsonSlurper

ext {
    // Define the function as a closure
    fetchTokenWithAzureCli = { ->
        try {
            print("ENTERING\n")
            // Command to issue an ACS token
            String azCommand = "az communication user-identity token issue --scope voip --output json"
            // Determine the appropriate command line based on the OS
            String[] commandLine
            if (System.getProperty("os.name").toLowerCase().contains("windows")) {
                commandLine = ["cmd", "/c", azCommand]
            } else {
                commandLine = ["sh", "-c", azCommand]
            }

            // Execute the command
            Process process = new ProcessBuilder(commandLine).start()
            process.waitFor() // Wait for the command to complete

            // Read the output of the command
            String output = process.getInputStream().text

            // Parse the JSON output to extract the token
            JsonSlurper jsonSlurper = new JsonSlurper()
            Map jsonResponse = jsonSlurper.parseText(output)
            String token = jsonResponse.token

            if (token) {
                return token
            } else {
                println "Failed to extract token from JSON response."
                return null
            }
        } catch (Exception e) {
            println "Error fetching ACS token: ${e.message}"
            return null
        }
    }
}
