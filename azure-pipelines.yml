# This pipeline was generated from the classic pipeline "SCC-SPOOL-communication-ui-library-Android-Localization" on 2023-10-28 with https://aka.ms/1ESPTMigration (v1.0.0): https://dev.azure.com/skype/SCC/_build?definitionId=12525
#
# The following items require attention:
# Variables were exported from the classic pipeline, confirm that `variables` values do not contain private information. If a variable contains private information, follow the guidance on handling secret variables: https://learn.microsoft.com/en-us/azure/devops/pipelines/process/set-secret-variables
# Secret variable 'tdbSecret' detected in `variables`, follow the guidance on handling secret variables: https://learn.microsoft.com/en-us/azure/devops/pipelines/process/set-secret-variables
# 'Allow scripts to access the OAuth token' was selected in pipeline.  Add the following YAML to any steps requiring access:
#       env:
#           MY_ACCESS_TOKEN: $(System.AccessToken)
# Cron Schedules have been converted using UTC Time Zone and may need to be updated for your location
# No trigger found, defaulting to 'none'. Update the trigger as needed.
# No name found, setting the default value '$(Date:yyyyMMdd).$(Rev:r)'. This value determines how your pipeline runs are numbered. Update the name as needed: https://learn.microsoft.com/en-us/azure/devops/pipelines/process/run-number?view=azure-devops&tabs=yaml
# The pipeline uses service connection "ServiceTree Gateway", you will need to grant the new pipeline access: https://dev.azure.com/skype/SCC/_settings/adminservices?resourceId=c29e963a-8ea3-4e6a-b28f-a035eaff83ab

name: $(Date:yyyyMMdd).$(Rev:r)
variables:
  - name: Ic3PipelineUsage
    value: production
  - name: sendToLocalization
    value: true
  - name: system.debug
    value: false
  - name: tdbSecret
    value: null
  - group: ServiceTreeLinkGroup
  - group: InfoSec-SecurityResults
schedules:
  - cron: 0 7 * * 1,2,3,4,5
    branches:
      include:
        - refs/heads/feature/localization-example
  - cron: 0 17 * * 1,2,3,4,5
    branches:
      include:
        - refs/heads/feature/localization-example
resources:
  repositories:
    - repository: self
      type: git
      ref: refs/heads/develop
    - repository: 1esPipelines
      type: git
      name: 1ESPipelineTemplates/1ESPipelineTemplates
      ref: refs/tags/release
trigger: none
extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1esPipelines
  parameters:
    pool:
      os: windows
      image: windows-2022
      name: Azure-Pipelines-1ESPT-ExDShared
    sdl:
      customCheckout:
        scanDirectory: $(System.DefaultWorkingDirectory)/azure-communication-ui/azure-communication-ui/
    customBuildTags:
      - MigrationTooling-skype-SCC-12525-Tool
    stages:
      - stage: Stage
        jobs:
          - job: Job_1
            displayName: Agent job 1
            steps:
              - checkout: self
                clean: true
                fetchTags: false
                persistCredentials: true
              - task: skvso.servicetree-build-tasks.servicetree-link-build-task.servicetree-link-build-task@1
                displayName: "ServiceTree: [$(BuildOutputUsage)] "
                condition: always()
                inputs:
                  ServiceTreeGateway: ServiceTree Gateway
                  Service: 5b23174b-8c6d-467d-862d-a3f24958fb74
              - task: Bash@3
                displayName: Set Git Configuration
                condition: ""
                inputs:
                  targetType: inline
                  script: |-
                    git config user.email "tdbuild@microsoft.com"
                    git config user.name "TDBuild Bot"
              - task: MicrosoftTDBuild.tdbuild-task.tdbuild-task.TouchdownBuildTask@1
                displayName: Touchdown Build build - No Commits
                condition: ne(variables['commit'], 'true')
                inputs:
                  teamId: "44987"
                  authId: $(AUTHID_)
                  authKey: $(AUTH_KEY)
                  relativePathRoot: azure-communication-ui/azure-communication-ui/src/main/res/values
                  resourceFilePath: azure_communication_ui_strings.xml;P:246
                  outputDirectoryRoot: azure-communication-ui/azure-communication-ui/src/main
                  cultureMappingType: Android
              - task: MicrosoftTDBuild.tdbuild-task.tdbuild-task.TouchdownBuildTask@1
                displayName: Touchdown Build Calling - Commit Changes
                condition: eq(variables['commit'], 'true')
                inputs:
                  teamId: "44987"
                  authId: $(AUTHID_)
                  authKey: $(AUTH_KEY)
                  relativePathRoot: azure-communication-ui/calling/src/main/res/values
                  resourceFilePath: azure_communication_ui_calling_strings.xml;P:246
                  outputDirectoryRoot: azure-communication-ui/calling/src/main/res
                  appendRelativeDir: false
                  cultureMappingType: Android
                  gitAction: COMMIT
              - task: Bash@3
                displayName: Copy Additional Calling String Files
                inputs:
                  targetType: inline
                  script: |
                    git config user.email "tdbuild@microsoft.com"
                    git config user.name "TDBuild Bot"

                    echo "git status"
                    git status

                    echo "git pull"
                    git pull

                    echo "target:source"
                    ARRAY=("de:de-rDE" "en-rUS:en" "es:es-rES" "fr:fr-rFR" "it:it-rIT" "ja:ja-rJP" "ko:ko-rKR" "nl:nl-rNL" "pt:pt-rBR" "ru:ru-rRU" "tr:tr-rTR" "zh:zh-rCN")
                    LOCALIZATION_PATH="azure-communication-ui/calling/src/main/res"
                    for mapping in "${ARRAY[@]}" ; do
                        KEY=${mapping%%:*}
                        VALUE=${mapping#*:}
                        cp -R -T $LOCALIZATION_PATH/values-$VALUE/ $LOCALIZATION_PATH/values-$KEY/
                        rm -rf $LOCALIZATION_PATH/values-en-rUS
                        mkdir $LOCALIZATION_PATH/values-en-rUS
                        cp $LOCALIZATION_PATH/values/azure_communication_ui_calling_strings.xml $LOCALIZATION_PATH/values-en-rUS/azure_communication_ui_calling_strings.xml
                    done

                    echo "git status"
                    git status

                    echo "git add"
                    git add $(System.DefaultWorkingDirectory)/$LOCALIZATION_PATH/*

                    echo "git status"
                    git status

                    echo "git commit -m 'add language mapping $(Build.BuildNumber)'"
                    git commit -m "add language mapping $(Build.BuildNumber)"

                    echo "git push -u origin HEAD:$(Build.SourceBranch)"
                    git push -u origin HEAD:$(Build.SourceBranch)
